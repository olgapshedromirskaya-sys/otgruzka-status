## Отгрузка Status: WB + Ozon FBS

Приложение полностью работает через API маркетплейсов:

- заказы не создаются вручную;
- данные подтягиваются из:
  - `https://api.wildberries.ru/api/v3/orders`
  - `https://api-seller.ozon.ru/v3/posting/fbs/list`
- синхронизация выполняется фоново каждые 15 минут через APScheduler;
- история статусов каждого заказа хранится в БД.

## Что есть в проекте

- **FastAPI** (API + WebApp)
- **SQLite + SQLAlchemy**
- **Telegram-бот (aiogram)**
- **APScheduler** для фоновой синхронизации
- **Экспорт заказов** в CSV и Excel
- **Ролевая модель доступа** (owner/admin)

## Статусы заказов (13)

1. Новый заказ  
2. Заказ на сборке  
3. Передан в доставку  
4. Принят на складе  
5. Товар в пути к покупателю  
6. Прибыл на ПВЗ покупателя  
7. Выкупили  
8. Возврат  
9. Покупатель отказался от товара  
10. Возврат вернули как брак  
11. Возврат в пути от покупателя  
12. Возврат прибыл на ПВЗ продавца  
13. Продавец товар забрал

## Быстрый запуск

```bash
python -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
cp .env.example .env
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

WebApp: `http://localhost:8000/`

## Роли и доступ

В системе есть 2 роли:

- `owner` (**Руководитель**) — полный доступ + добавление/удаление сотрудников.
- `admin` (**Администратор**) — полный доступ к дашборду и заказам, без управления сотрудниками.

Пользователи хранятся в таблице `users`:

- `telegram_id` (int, уникальный),
- `role` (`owner` / `admin`),
- `full_name` (str),
- `added_at` (datetime),
- `added_by` (int, telegram_id пользователя, который добавил запись).

При старте приложения, если таблица `users` пуста, автоматически создаётся первый `owner` из переменной окружения `OWNER_TELEGRAM_ID`.

Если пользователя нет в таблице `users`, бот и WebApp возвращают отказ в доступе:
`У вас нет доступа. Обратитесь к руководителю.`

## Настройки API ключей

Ключи хранятся в таблице `settings`:

- `wb_token`
- `ozon_client_id`
- `ozon_api_key`

Указать/изменить ключи можно из вкладки **«Настройки»** в WebApp.

## Переменные окружения

Минимально необходимые переменные:

- `BOT_TOKEN` — токен Telegram-бота.
- `WEBAPP_URL` — публичный URL приложения.
- `OWNER_TELEGRAM_ID` — Telegram ID руководителя (первого owner).
- `DATABASE_URL` — строка подключения к БД.
- `TIMEZONE` — часовой пояс приложения.

Для Render обязательно добавьте:

`OWNER_TELEGRAM_ID=<telegram_id руководителя>`

## Основные API-эндпоинты

- `GET /api/meta/statuses` — справочник статусов
- `GET /api/orders?marketplace=wb|ozon` — список заказов + история
- `GET /api/dashboard/{marketplace}` — сводка по WB/Ozon
- `GET /api/settings` / `PUT /api/settings` — чтение/сохранение ключей
- `POST /api/sync/run` — ручной запуск синхронизации
- `GET /api/export/orders.csv` — экспорт CSV
- `GET /api/export/orders.xlsx` — экспорт Excel

## Бот

Команды:

- `/start` — открыть меню (только для пользователей из `users`)
- `/help` — справка
- `/addadmin [telegram_id] [имя]` — добавить администратора (только owner)
- `/removeuser [telegram_id]` — удалить пользователя (только owner)
- `/users` — список пользователей с ролями (только owner)

Кнопки меню:

- `Заказы WB`
- `Заказы Ozon`
- `Сводка за сегодня`
- `Открыть дашборд`
- `Настройки`

`Заказы WB/Ozon` показывают последние 10 заказов с текущими статусами.

WebApp доступен только авторизованным пользователям через Telegram WebApp `initData`.
